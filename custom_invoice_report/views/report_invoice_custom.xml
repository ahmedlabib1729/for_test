<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Define the report -->
    <record id="action_report_invoice_custom" model="ir.actions.report">
        <field name="name">Tax Invoice (Custom)</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">custom_invoice_report.report_invoice_custom_document</field>
        <field name="report_file">custom_invoice_report.report_invoice_custom_document</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>

    <!-- Main report template -->
    <template id="report_invoice_custom_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="custom_invoice_report.report_invoice_custom_layout">
                    <t t-set="o" t-value="o"/>
                </t>
            </t>
        </t>
    </template>

    <!-- Invoice Layout -->
    <template id="report_invoice_custom_layout">
        <div class="article o_report_layout_standard" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id">
            <t t-set="company" t-value="o.company_id"/>
            
            <style>
                @page {
                    margin: 0mm;
                    size: A4;
                }
                
                body {
                    font-family: 'Courier New', monospace;
                    font-size: 10pt;
                    line-height: 1.3;
                    margin: 0;
                    padding: 15mm 10mm;
                }
                
                .invoice-container {
                    width: 100%;
                    max-width: 190mm;
                    margin: 0 auto;
                }
                
                .header-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 5mm;
                }

                .header-table td {
                    width: 33.33%;
                    padding: 2mm;
                    vertical-align: top;
                }

                .header-table .left {
                    text-align: left;
                }

                .header-table .center {
                    text-align: center;
                }

                .header-table .right {
                    text-align: right;
                }

                .party-info {
                    margin-bottom: 3mm;
                    border: 1px solid black;
                    padding: 2mm;
                }

                .info-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 3mm;
                }

                .info-table td {
                    padding: 1mm 2mm;
                    border: 1px solid black;
                }

                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 3mm;
                    font-size: 9pt;
                }

                .items-table th,
                .items-table td {
                    border: 1px solid black;
                    padding: 2mm;
                    text-align: left;
                }

                .items-table th {
                    background-color: #f0f0f0;
                    font-weight: bold;
                    text-align: center;
                }

                .items-table td.number {
                    text-align: right;
                }

                .items-table td.center {
                    text-align: center;
                }

                .summary-section {
                    margin-bottom: 3mm;
                }

                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 1mm;
                }

                .vat-summary-table {
                    width: 50%;
                    float: right;
                    border-collapse: collapse;
                    margin-bottom: 3mm;
                    font-size: 9pt;
                }

                .vat-summary-table th,
                .vat-summary-table td {
                    border: 1px solid black;
                    padding: 2mm;
                    text-align: right;
                }

                .vat-summary-table th {
                    background-color: #f0f0f0;
                    font-weight: bold;
                    text-align: center;
                }

                .words-section {
                    clear: both;
                    margin-bottom: 3mm;
                    font-size: 9pt;
                }

                .declaration {
                    margin-bottom: 3mm;
                    font-size: 9pt;
                }

                .footer-text {
                    text-align: center;
                    font-size: 9pt;
                    font-style: italic;
                    margin-top: 5mm;
                }

                .bold {
                    font-weight: bold;
                }

                .underline {
                    text-decoration: underline;
                }

                .right-align {
                    text-align: right;
                }

                hr {
                    border: none;
                    border-top: 1px solid black;
                    margin: 2mm 0;
                }
            </style>

            <div class="invoice-container">
                <!-- Header Section -->
                <table class="header-table">
                    <tr>
                        <td class="left">
                            <div>Invoice No. <span class="bold"><t t-esc="o.name"/></span></div>
                        </td>
                        <td class="center">
                            <div class="bold" style="font-size: 12pt;">Tax Invoice</div>
                        </td>
                        <td class="right">
                            <div>Dated. <t t-esc="o.invoice_date.strftime('%d-%b-%Y') if o.invoice_date else ''"/></div>
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            <div>Ref No. <t t-esc="o.ref or 'N/A'"/></div>
                        </td>
                        <td class="center">
                            <div t-if="o.company_id.company_registry">CR.NO-<t t-esc="o.company_id.company_registry"/></div>
                        </td>
                        <td class="right">
                            <div>&#160;</div>
                        </td>
                    </tr>
                </table>

                <!-- Party Information -->
                <div class="party-info">
                    <div><span class="bold">Party</span>&#160;&#160;&#160;&#160;<t t-esc="o.partner_id.name"/></div>
                    <div style="margin-left: 20mm;"><t t-esc="o.partner_id.street or ''"/></div>
                    <div style="margin-left: 20mm;"><t t-esc="o.partner_id.street2 or ''"/></div>
                    <div><span class="bold">VAT</span>&#160;&#160;&#160;&#160;<t t-esc="o.partner_id.vat or ''"/></div>
                    <div><span class="bold">Country</span>&#160;&#160;&#160;&#160;<t t-esc="o.partner_id.country_id.name or ''"/></div>
                </div>

                <!-- Payment Terms, Despatch, Delivery -->
                <table class="info-table">
                    <tr>
                        <td style="width: 33%;"><span class="bold">Payment Terms</span><br/><t t-esc="o.invoice_payment_term_id.name if o.invoice_payment_term_id else 'Immediate Payment'"/></td>
                        <td style="width: 33%;"><span class="bold">Despatch Document No.</span><br/><t t-esc="o.ref or ''"/></td>
                        <td style="width: 34%;">
                            <span class="bold">Delivery Note</span><br/>
                            <t t-set="delivery_orders" t-value="o.invoice_line_ids.mapped('sale_line_ids.order_id.picking_ids').filtered(lambda p: p.state == 'done' and p.picking_type_id.code == 'outgoing')"/>
                            <t t-if="delivery_orders">
                                <t t-foreach="delivery_orders" t-as="picking">
                                    <t t-esc="picking.name"/><t t-if="not picking_last">, </t>
                                </t>
                                dt. <t t-esc="o.invoice_date.strftime('%d-%b-%Y') if o.invoice_date else ''"/>
                            </t>
                            <t t-else="">
                                <t t-if="o.invoice_origin"><t t-esc="o.invoice_origin"/> dt. <t t-esc="o.invoice_date.strftime('%d-%b-%Y') if o.invoice_date else ''"/></t>
                            </t>
                        </td>
                    </tr>
                </table>

                <!-- Items Table -->
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">Sl.No.</th>
                            <th style="width: 35%;">Description of Goods</th>
                            <th style="width: 8%;">Quantity</th>
                            <th style="width: 8%;">Rate</th>
                            <th style="width: 6%;">Disc. %</th>
                            <th style="width: 10%;">Amount<br/>Excl.VAT</th>
                            <th style="width: 8%;">VAT %</th>
                            <th style="width: 10%;">VAT (<span t-field="o.currency_id.name"/>)</th>
                            <th style="width: 10%;">Total Incl.<br/>VAT(<span t-field="o.currency_id.name"/>)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="line_number" t-value="0"/>
                        <t t-foreach="o.invoice_line_ids" t-as="line">
                            <!-- Show only product lines, not sections or notes -->
                            <t t-if="line.display_type not in ['line_section', 'line_note']">
                                <t t-set="line_number" t-value="line_number + 1"/>
                                <tr>
                                    <td class="center"><span t-esc="line_number"/></td>
                                    <td>
                                        <div><span t-field="line.product_id.name"/></div>
                                        <div class="bold"><span t-field="line.product_id.default_code"/></div>
                                    </td>
                                    <td class="number">
                                        <span t-esc="'{:.0f}'.format(line.quantity)"/> SETS
                                    </td>
                                    <td class="number"><span t-esc="'{:.3f}'.format(line.price_unit)"/></td>
                                    <td class="number"><span t-esc="'{:.2f}'.format(line.discount)"/></td>
                                    <td class="number"><span t-esc="'{:.3f}'.format(line.price_subtotal)"/></td>
                                    <td class="center">
                                        <t t-foreach="line.tax_ids" t-as="tax">
                                            <span t-field="tax.name"/><t t-if="not tax_last"><br/></t>
                                        </t>
                                    </td>
                                    <td class="number">
                                        <t t-set="tax_amount" t-value="line.price_total - line.price_subtotal"/>
                                        <span t-esc="'{:.3f}'.format(tax_amount)"/>
                                    </td>
                                    <td class="number"><span t-esc="'{:.3f}'.format(line.price_total)"/></td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <!-- Subtotal and VAT -->
                <div class="summary-section">
                    <div class="right-align" style="padding-right: 60mm;">
                        <div style="text-decoration:;"><t t-esc="'%.3f' % o.amount_untaxed"/></div>
                        <div class="bold">VAT-Output&#160;&#160;&#160;&#160;<t t-esc="'%.3f' % o.amount_tax"/></div>
                    </div>
                </div>

                <!-- Total Row -->
                <table class="items-table">
                    <tr>
                        <td class="center bold" style="width: 38%;">Total</td>
                        <td class="number" style="width: 8%;"><t t-esc="'%.0f %s' % (sum(o.invoice_line_ids.mapped('quantity')), 'SETS')"/></td>
                        <td class="number bold" style="width: 34%;"><t t-esc="o.currency_id.name"/> <t t-esc="'%.3f' % o.amount_total"/></td>
                        <td class="number" style="width: 10%;"><t t-esc="'%.3f' % o.amount_tax"/></td>
                        <td class="number" style="width: 10%;"><t/></td>
                    </tr>
                </table>

                <!-- Amount in Words -->
                <div class="words-section">
                    <div><span class="bold">Amount Chargable(in words)</span></div>
                    <div><t t-esc="o.get_amount_total_words()"/></div>
                    <div style="margin-top: 2mm;"><span class="bold">VAT Amount(in words)</span></div>
                    <div><t t-esc="o.get_vat_amount_words()"/></div>
                </div>

                <!-- VAT Summary Table -->
                <table class="vat-summary-table">
                    <thead>
                        <tr>
                            <th>VAT %</th>
                            <th>Assessable<br/>Value</th>
                            <th>Tax Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.get_vat_summary()" t-as="vat">
                            <tr>
                                <td><t t-esc="vat['rate']"/></td>
                                <td><t t-esc="'%.3f' % vat['assessable_value']"/></td>
                                <td><t t-esc="'%.1f' % vat['tax_amount']"/></td>
                            </tr>
                        </t>
                        <tr class="bold">
                            <td>Total</td>
                            <td><t t-esc="'%.3f' % o.amount_untaxed"/></td>
                            <td><t t-esc="'%.3f' % o.amount_tax"/></td>
                        </tr>
                    </tbody>
                </table>

                <div style="clear: both;"></div>

                <!-- Remarks -->
                <div class="declaration">
                    <div class="bold">Remarks</div>
                    <div><t t-esc="o.narration or 'N/A'"/></div>
                </div>

                <!-- Declaration -->
                <div class="declaration">
                    <div class="bold underline">Declaration</div>
                    <div>We declare that this invoice shows the actual price of the goods described and that all particulars are true and correct.</div>
                </div>

                <!-- Signature Section -->
                <div style="margin-top: 8mm; margin-bottom: 2mm;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="width: 50%; text-align: left; padding: 0; vertical-align: top;">
                                <span class="bold">Customer's seal and signature</span>
                            </td>
                            <td style="width: 50%; text-align: right; padding: 0; vertical-align: top;">
                                <span class="bold">for <t t-esc="o.company_id.name"/></span>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Three signature columns -->
                <table style="width: 100%; border-collapse: collapse; margin-top: 15mm; margin-bottom: 3mm;">
                    <tr>
                        <td style="width: 33.33%; text-align: center; padding: 0;">
                            <div class="bold">Prepared By</div>
                        </td>
                        <td style="width: 33.33%; text-align: center; padding: 0;">
                            <div class="bold">Verified By</div>
                        </td>
                        <td style="width: 33.33%; text-align: center; padding: 0;">
                            <div class="bold">Authorised Signatory</div>
                        </td>
                    </tr>
                </table>

                <!-- Footer Text -->
                <div style="text-align: center; margin-top: 2mm;">
                    <div class="bold underline">This is a Computer Generated Invoice.</div>
                </div>
            </div>
        </div>
    </template>


</odoo>
